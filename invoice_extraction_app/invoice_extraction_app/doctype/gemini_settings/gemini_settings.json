{
  "name": "Gemini Settings",
  "doctype": "DocType",
  "module": "Invoice Extraction App",
  "custom": 1,
  "issingle": 1,
  "fields": [
    {
      "fieldname": "gemini_api_key",
      "fieldtype": "Data",
      "label": "Gemini API Key",
      "reqd": 0,
      "description": "API Key from Google AI Studio"
    },
    {
      "fieldname": "gemini_keys",
      "fieldtype": "Table",
      "label": "Gemini Keys",
      "reqd": 0,
      "options": "Gemini API Key"
    },
    {
      "fieldname": "selected_model",
      "fieldtype": "Select",
      "label": "Selected Model",
      "options": "gemini-2.5-flash\ngemini-2.0-flash-exp\ngemini-1.5-flash\ngemini-1.5-pro",
      "default": "gemini-2.5-flash",
      "reqd": 1
    },
    {
      "fieldname": "temperature",
      "fieldtype": "Float",
      "label": "Temperature",
      "default": 0.1,
      "description": "Creativity level (0 = precise, 1 = creative)"
    },
    {
      "fieldname": "enable_tax_extraction",
      "fieldtype": "Check",
      "label": "Enable Tax Extraction",
      "hidden": 1,
      "default": 1
    },
    {
      "fieldname": "default_currency",
      "fieldtype": "Select",
      "label": "Default Currency",
      "options": "SAR\nUSD\nEUR\nAED",
      "hidden": 1,
      "default": "SAR"
    },
    {
      "fieldname": "section_break_001",
      "label": "Instructions",
      "fieldtype": "Section Break",
      "collapsible": 1
      
    },
    {
      "default": "أنت متخصص في استخراج البيانات من فواتير الشراء.\nاستخرج البيانات بدقة مع التركيز على تفاصيل الضرائب والحسابات المالية.",
      "fieldname": "system_instruction",
      "fieldtype": "Text",
      "label": "System Instruction"
     },
     {
      "default": "**القواعد المهمة بالترتيب:**\n\n1. **استخراج الضريبة:**\n   - استخرج `tax_amount` (مبلغ الضريبة) فقط - لا حاجة لنسبة الضريبة\n   - إذا كانت الفاتورة تحتوي على ضريبة: استخرج `tax_amount` كقيمة رقمية\n   - إذا لم تكن هناك ضريبة: ضع `tax_amount = 0`\n\n2. **استخراج الأصناف:**\n   - لكل صنف، استخرج:\n     - `tax_amount` للصنف (مبلغ الضريبة لهذا الصنف فقط)\n     - `item_total` (الكمية × سعر الوحدة)\n     - `total_with_tax` (item_total + tax_amount للصنف)\n   - إذا لم يكن الصنف خاضع للضريبة: `tax_amount = 0` للصنف\n   - `total_with_tax` يجب أن يساوي `item_total + tax_amount` لكل صنف\n\n3. **حساب الإجماليات:**\n   - `subtotal` = مجموع `item_total` لجميع الأصناف\n   - `tax_amount` (للإجمالي) = مجموع `tax_amount` لجميع الأصناف\n   - `total_amount` = `subtotal + tax_amount` (للإجمالي)\n   - إذا كان `total_amount` ناقصاً: احسبه = `subtotal + tax_amount`\n\n4. **التحقق من الحسابات:**\n   - تأكد أن: مجموع `item_total` لجميع الأصناف ≈ `subtotal`\n   - تأكد أن: مجموع `tax_amount` لجميع الأصناف ≈ `tax_amount` للإجمالي\n   - تأكد أن: `total_amount` = `subtotal + tax_amount`\n\n5. **التنسيق:**\n   - التواريخ: YYYY-MM-DD\n   - العملة: SAR أو USD أو EUR (الرمز فقط)\n   - الأرقام: قيم رقمية فقط (بدون رموز العملة)\n\n**سيناريوهات خاصة:**\n1. إذا كانت الضريبة موضحة كقيمة إجمالية فقط: وزعها على الأصناف تناسبياً\n2. إذا كانت الضريبة موضحة لكل صنف: استخدم القيم كما هي\n3. إذا لم تظهر الضريبة في الفاتورة: `tax_amount = 0` للجميع\n4. إذا كان هناك خصم: أضفه كصنف منفصل أو اطرحه من subtotal\n\n**هام جداً:** \n- `tax_amount` هو مبلغ الضريبة فقط (قيمة رقمية)\n- إذا لم توجد ضريبة: `tax_amount = 0`\n- `total_amount` = `subtotal + tax_amount`",
      "fieldname": "prompt_instructions",
      "fieldtype": "Text Editor",
      "label": "Prompt Instructions"
     },
     {
      "default": "{\n    \"supplier\": \"اسم المورد\",\n    \"supplier_ar\": \"اسم المورد بالعربية\",\n    \"invoice_number\": \"رقم الفاتورة\",\n    \"date\": \"تاريخ الفاتورة (YYYY-MM-DD)\",\n    \"due_date\": \"تاريخ الاستحقاق (YYYY-MM-DD)\",\n    \"subtotal\": \"المبلغ قبل الضريبة\",\n    \"tax_amount\": \"مبلغ الضريبة الإجمالي\",\n    \"total_amount\": \"المبلغ الإجمالي بعد الضريبة\",\n    \"currency\": \"العملة\",\n    \"items\": [\n        {\n            \"description\": \"وصف الصنف\",\n            \"description_ar\": \"وصف الصنف بالعربية\",\n            \"quantity\": الكمية,\n            \"unit_price\": سعر الوحدة,\n            \"item_total\": \"المبلغ الإجمالي للصنف (الكمية × السعر)\",\n            \"tax_amount\": \"مبلغ الضريبة للصنف\",\n            \"total_with_tax\": \"المبلغ الإجمالي للصنف بعد الضريبة\"\n        }\n    ]\n}",
      "fieldname": "json_format",
      "fieldtype": "Code",
      "label": "JSON Format",
      "options": "JSON"
     },
     {
      "depends_on": "eval:doc.system_instruction || doc.json_format || doc.prompt_instructions",
      "fieldname": "prompt_preview",
      "fieldtype": "HTML",
      "label": "Prompt Preview",
      "options": "<div style='max-height: 300px; overflow-y: auto; padding: 10px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px;'>\n    <h5 style='margin-top: 0;'>معاينة الـ Prompt:</h5>\n    <pre style='white-space: pre-wrap; word-wrap: break-word; margin: 0;' id='prompt-preview'></pre>\n</div>\n<script>\nfrappe.ui.form.on('Gemini Settings', {\n    refresh: function(frm) {\n        update_prompt_preview(frm);\n    },\n    system_instruction: function(frm) {\n        update_prompt_preview(frm);\n    },\n    json_format: function(frm) {\n        update_prompt_preview(frm);\n    },\n    prompt_instructions: function(frm) {\n        update_prompt_preview(frm);\n    }\n});\n\nfunction update_prompt_preview(frm) {\n    let preview = '';\n    if (frm.doc.system_instruction) {\n        preview += frm.doc.system_instruction + '\\n\\n';\n    }\n    preview += 'من فضلك استخرج البيانات من هذه الفاتورة وأرجعها بتنسيق JSON التالي:\\n\\n';\n    if (frm.doc.json_format) {\n        preview += frm.doc.json_format + '\\n\\n';\n    }\n    if (frm.doc.prompt_instructions) {\n        preview += frm.doc.prompt_instructions;\n    }\n    $('#prompt-preview').text(preview);\n}\n</script>"
     }
  ],

  "permissions": [
    {
      "role": "System Manager",
      "read": 1,
      "write": 1,
      "create": 1,
      "delete": 1,
      "report": 1,
      "export": 1,
      "share": 1,
      "print": 1,
      "email": 1
    }
  ]
}



